name: Multi-Platform Build

on:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Lazarus via WinGet
        run: |
          winget install --id Lazarus.Lazarus --silent --accept-source-agreements --accept-package-agreements

      - name: Locate FPC and Make
        shell: pwsh
        run: |
          # 1. Find the root lazarus folder (default is C:\lazarus)
          $lazPath = Get-ChildItem -Path C:\ -Filter "lazarus" -Directory -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName

          if (-not $lazPath) { $lazPath = "C:\lazarus" }

          # 2. Find the bin folder containing fpc.exe and make.exe
          $fpcBin = Get-ChildItem -Path $lazPath -Filter "fpc.exe" -Recurse | Select-Object -First 1 -ExpandProperty DirectoryName
          $makeBin = Get-ChildItem -Path $lazPath -Filter "make.exe" -Recurse | Select-Object -First 1 -ExpandProperty DirectoryName

          Write-Host "Found FPC at: $fpcBin"
          Write-Host "Found Make at: $makeBin"

          # 3. Add to GitHub Path
          echo "$fpcBin" >> $env:GIBHUB_PATH
          echo "$makeBin" >> $env:GITHUB_PATH

      - name: Build with CMake
        shell: pwsh
        run: |
          cmake -G "MinGW Makefiles" -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-windows
          path: build/bin/main.exe